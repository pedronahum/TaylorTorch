name: Ubuntu CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
<<<<<<< HEAD
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pedronahum/taylortorch:latest
      options: --user root
=======
    runs-on: ubuntu-24.04

    env:
      SWIFT_VERSION: swift-DEVELOPMENT-SNAPSHOT-2025-10-02-a
      SWIFT_PLATFORM: ubuntu24.04
      PYTORCH_VERSION: v2.8.0
      PYTORCH_INSTALL_DIR: /opt/pytorch
      SWIFT_TOOLCHAIN_DIR: /usr
      CC: clang
      CXX: clang++
>>>>>>> 0c78e25 (Codespaces & CI)

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

<<<<<<< HEAD
    - name: Set up environment
      run: |
        # Source the environment script from the Docker image
        . /etc/profile.d/swift.sh
        
        # Verify the environment was sourced correctly
        echo "Swift toolchain: $SWIFT_TOOLCHAIN_DIR"
        echo "PyTorch install: $PYTORCH_INSTALL_DIR"
        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
        
        # For PATH, we need to add each directory separately
        # Extract the Swift-specific paths from the PATH
        SWIFT_BIN_DIR="${SWIFT_TOOLCHAIN_DIR}/bin"
        SWIFTLY_BIN_DIR="/root/.local/share/swiftly/bin"
        
        # Add paths to GITHUB_PATH (one per line)
        echo "${SWIFTLY_BIN_DIR}" >> $GITHUB_PATH
        echo "${SWIFT_BIN_DIR}" >> $GITHUB_PATH
        
        # Persist environment variables for subsequent steps
        echo "SWIFT_TOOLCHAIN_DIR=${SWIFT_TOOLCHAIN_DIR}" >> $GITHUB_ENV
        echo "SWIFT_TOOLCHAIN_PATH=${SWIFT_TOOLCHAIN_PATH}" >> $GITHUB_ENV
        echo "PYTORCH_INSTALL_DIR=${PYTORCH_INSTALL_DIR}" >> $GITHUB_ENV
        echo "CC=${CC}" >> $GITHUB_ENV
        echo "CXX=${CXX}" >> $GITHUB_ENV
        
        # CRITICAL: Persist LD_LIBRARY_PATH for linking
        echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        
        # Also set SDKROOT if it exists (needed for proper compilation)
        if [ -n "$SDKROOT" ]; then
          echo "SDKROOT=${SDKROOT}" >> $GITHUB_ENV
        fi

    - name: Verify environment
      run: |
        echo "=== Environment Check ==="
        echo "Swift version:"
        swift --version
        echo ""
        echo "Swift toolchain: $SWIFT_TOOLCHAIN_DIR"
        echo "PyTorch install: $PYTORCH_INSTALL_DIR"
        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo ""
        echo "PyTorch libraries:"
        ls -lh ${PYTORCH_INSTALL_DIR}/lib/ | grep -E "(libtorch|libc10)" || true
        echo "========================="

    - name: Build TaylorTorch
      run: |
        # Ensure LD_LIBRARY_PATH is set for the build
        export LD_LIBRARY_PATH="${PYTORCH_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"
        swift build -c release -v

    - name: Run tests
      run: |
        # Ensure LD_LIBRARY_PATH is set for tests
        export LD_LIBRARY_PATH="${PYTORCH_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"
        swift test -c release 

    - name: Build examples
      run: |
        # Ensure LD_LIBRARY_PATH is set for example builds
        export LD_LIBRARY_PATH="${PYTORCH_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"
=======
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          binutils \
          git \
          gnupg2 \
          libc6-dev \
          libcurl4-openssl-dev \
          libedit2 \
          libgcc-13-dev \
          libpython3-dev \
          libsqlite3-0 \
          libstdc++-13-dev \
          libxml2-dev \
          libz3-dev \
          pkg-config \
          python3-lldb \
          tzdata \
          unzip \
          zip \
          zlib1g-dev \
          wget \
          curl \
          ca-certificates

    - name: Install PyTorch build dependencies
      run: |
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgoogle-glog-dev \
          libgtest-dev \
          libomp-17-dev \
          libleveldb-dev \
          liblmdb-dev \
          libopencv-dev \
          libopenmpi-dev \
          libsnappy-dev \
          libprotobuf-dev \
          openmpi-bin \
          openmpi-doc \
          protobuf-compiler \
          python3 \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-yaml \
          libgflags-dev \
          libc++-17-dev \
          libc++abi-17-dev \
          ninja-build

    - name: Install Python packages for PyTorch
      run: |
        pip3 install --break-system-packages \
          numpy \
          pyyaml \
          typing_extensions \
          sympy \
          cffi \
          cmake

    - name: Cache Swift toolchain
      id: cache-swift
      uses: actions/cache@v4
      with:
        path: /tmp/swift-toolchain
        key: swift-${{ env.SWIFT_VERSION }}-${{ env.SWIFT_PLATFORM }}

    - name: Download and install Swift
      if: steps.cache-swift.outputs.cache-hit != 'true'
      run: |
        SWIFT_URL=https://download.swift.org/development/ubuntu2404/${SWIFT_VERSION}/${SWIFT_VERSION}-${SWIFT_PLATFORM}.tar.gz
        wget -q $SWIFT_URL
        mkdir -p /tmp/swift-toolchain
        tar xzf ${SWIFT_VERSION}-${SWIFT_PLATFORM}.tar.gz -C /tmp/swift-toolchain --strip-components=1
        rm ${SWIFT_VERSION}-${SWIFT_PLATFORM}.tar.gz

    - name: Install Swift to system
      run: |
        sudo cp -r /tmp/swift-toolchain/* /usr/
        sudo chmod -R o+r /usr/lib/swift
        swift --version

    - name: Cache PyTorch build
      id: cache-pytorch
      uses: actions/cache@v4
      with:
        path: /opt/pytorch
        key: pytorch-${{ env.PYTORCH_VERSION }}-ubuntu-clang-${{ hashFiles('.github/workflows/ubuntu-ci.yml') }}

    - name: Clone PyTorch
      if: steps.cache-pytorch.outputs.cache-hit != 'true'
      run: |
        git clone --recursive https://github.com/pytorch/pytorch.git /tmp/pytorch
        cd /tmp/pytorch
        git checkout ${PYTORCH_VERSION}
        git submodule sync
        git submodule update --init --recursive

    - name: Build PyTorch
      if: steps.cache-pytorch.outputs.cache-hit != 'true'
      run: |
        cd /tmp/pytorch
        mkdir -p build
        cd build
        CC=clang CXX=clang++ cmake .. \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/opt/pytorch \
          -DBUILD_PYTHON=OFF \
          -DBUILD_TEST=OFF \
          -DBUILD_CAFFE2=ON \
          -DUSE_DISTRIBUTED=OFF \
          -DUSE_MPS=OFF \
          -DUSE_NNPACK=ON \
          -DUSE_XNNPACK=ON \
          -DUSE_OPENMP=ON \
          -DUSE_SYSTEM_BLAS=ON \
          -DUSE_CUDA=OFF \
          -DPYTHON_EXECUTABLE=$(which python3)
        cmake --build . --target install -j$(nproc)

    - name: Fix PyTorch permissions
      if: steps.cache-pytorch.outputs.cache-hit != 'true'
      run: |
        sudo mkdir -p /opt/pytorch
        sudo cp -r /tmp/pytorch/build/install/* /opt/pytorch/ || true

    - name: Set up environment
      run: |
        echo "PYTORCH_INSTALL_DIR=/opt/pytorch" >> $GITHUB_ENV
        echo "SWIFT_TOOLCHAIN_DIR=/usr" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/opt/pytorch/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "/opt/pytorch/lib" | sudo tee -a /etc/ld.so.conf.d/pytorch.conf
        sudo ldconfig

    - name: Build TaylorTorch
      run: |
        swift build -c release

    - name: Run tests
      run: |
        swift test -c release

    - name: Build examples
      run: |
>>>>>>> 0c78e25 (Codespaces & CI)
        swift build -c release --product MNISTExample
        swift build -c release --product ANKIExample
        swift build -c release --product KARATEExample
